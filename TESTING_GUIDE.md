# Тестирование виртуального live счета

## Резюме: Что было реализовано

### ⚙️ Режимы Live/Paper и ключевые проверки
- Для прогонов в тестовом окружении держите `PAPER = True` в `strategies/live.py` и прописывайте paper-ключи в `.env` (`ALPACA_API_KEY_LIVE`/`ALPACA_SECRET_KEY_LIVE` указывают на paper). Перед переключением в бой вернуть `PAPER = False` и задать боевые ключи.
- Контрольные суммы: при расхождении виртуального и реального баланса > $1 ребаланс падает; ежечасно срабатывает watchdog и шлёт алерт админам через Telegram.
- Активные инвесторы: расчёты ведутся только по инвесторам со статусом `active`; удаляйте/не храните тестовые trades/operations для отключённых, чтобы не влиять на балансные проверки.
- Реальные позиции первичны: при ребалансе LiveStrategy ориентируется только на фактические позиции Alpaca, леджер — вторичен для распределения.

### 1. ✅ Исправлен расчет баланса инвестора
**Файл:** `core/investor_manager.py`

**Что изменилось:**
- Добавлен расчет `positions_value` из файла `trades.csv`
- Добавлен расчет `pnl` (realized и unrealized) из истории сделок
- Обновлен `_calculate_account_balance()` чтобы учитывать BUY/SELL операции
  - BUY уменьшает cash
  - SELL увеличивает cash
- Обновлен `calculate_investor_balance()` чтобы возвращать полную информацию:
  ```python
  {
    'low': {
      'cash': X,                    # Deposited - Spent on buys + Received from sells
      'positions_value': Y,         # Current market value of positions
      'pnl': Z,                     # Realized PnL + Unrealized PnL
      'total_value': X + Y          # Cash + Positions Value
    },
    'medium': {...},
    'high': {...},
    'total_value': X + Y + Z        # Sum of all accounts
  }
  ```

### 2. ✅ Реализован расчет P&L
**Методы:**
- `_get_investor_positions()` - получить текущие позиции из trades.csv
- `_calculate_positions_value_and_pnl()` - рассчитать positions_value и P&L

**Логика:**
- **Positions Value** = SUM(current_shares * current_price) для каждого тикера
- **Realized P&L** = прибыль/убыток от закрытых позиций (SELL операции)
  - Рассчитывается как: (price_sold - avg_cost) * shares_sold
- **Unrealized P&L** = прибыль/убыток открытых позиций
  - Рассчитывается как: (current_price - avg_cost) * current_shares
- **Average Cost** = total_cost_of_buys / total_shares_bought (FIFO метод)

### 3. ✅ Написаны comprehensive интеграционные тесты (5 тестов)
**Файл:** `tests/test_investor_manager_integration.py`

#### Сценарий тестирования:
3 инвестора вносят депозиты:
- **Alexey:** $10,000 (→ LOW: $4,500, MEDIUM: $3,500, HIGH: $2,000)
- **Alex:** $5,000 (→ LOW: $2,250, MEDIUM: $1,750, HIGH: $1,000)
- **Cherry:** $10,000 (→ LOW: $4,500, MEDIUM: $3,500, HIGH: $2,000)
- **Total:** $25,000

#### Тесты:
1. **test_deposit_default_allocation** ✅
   - Проверка: депозит распределяется 45/35/20 по счетам
   - Результат: 3 pending операции созданы правильно

2. **test_distribute_trade_proportional** ✅
   - Проверка: сделки распределяются пропорционально капиталу
   - Сценарий: BUY 100 AAPL @ $100 на LOW
   - Результат:
     - Alexey: 40 акций ($4,000)
     - Alex: 20 акций ($2,000)
     - Cherry: 40 акций ($4,000)

3. **test_balance_calculation_with_positions** ✅
   - Проверка: баланс включает positions_value и учитывает расходы на покупки
   - Сценарий: BUY 10 AAPL @ $100 на LOW
   - Результат Cherry:
     - LOW: $4,100 cash (из $4,500 депозита) + $400 positions = $4,500 total
     - Все 3 инвестора: $25,000 total ✅

4. **test_pnl_with_price_increase** ✅
   - Проверка: расчет P&L при росте цены
   - Сценарий: BUY 100 AAPL @ $100, цена выросла до $120
   - Результат: positions_value = $12,000, unrealized_pnl = $2,000 ✅

5. **test_balance_integrity_check** ✅
   - Проверка: целостность контрольных сумм
   - Результат:
     - Total virtual = $25,000
     - LOW = $11,250 (45%)
     - MEDIUM = $8,750 (35%)
     - HIGH = $5,000 (20%)

### 4. ✅ Написаны unit тесты (10 тестов)
**Файл:** `tests/test_investor_manager_unit.py`

#### TestPositionsCalculation (4 теста):
1. **test_get_investor_positions_empty** ✅
   - Позиции без сделок = пусто

2. **test_get_investor_positions_single_buy** ✅
   - BUY 100 AAPL → {AAPL: 100}

3. **test_get_investor_positions_buy_and_sell** ✅
   - BUY 100 AAPL, SELL 30 AAPL → {AAPL: 70}

4. **test_get_investor_positions_multiple_tickers** ✅
   - Multiple BUY/SELL → {AAPL: 80, MSFT: 50}

#### TestPnLCalculation (6 тестов):
1. **test_pnl_no_trades** ✅
   - P&L без сделок = 0

2. **test_unrealized_pnl_price_increase** ✅
   - BUY 100 @ $150, цена = $160
   - Результат: positions = $16,000, unrealized_pnl = $1,000

3. **test_unrealized_pnl_price_decrease** ✅
   - BUY 100 @ $150, цена = $140
   - Результат: positions = $14,000, unrealized_pnl = -$1,000

4. **test_realized_pnl_sell_at_profit** ✅
   - BUY 100 @ $150, SELL 100 @ $160
   - Результат: realized_pnl = $1,000

5. **test_realized_pnl_sell_at_loss** ✅
   - BUY 100 @ $150, SELL 100 @ $140
   - Результат: realized_pnl = -$1,000

6. **test_combined_realized_and_unrealized_pnl** ✅
   - BUY 100 @ $150, SELL 50 @ $160, цена = $170
   - Результат:
     - realized_pnl = $500 (от проданных 50)
     - unrealized_pnl = $1,000 (от оставшихся 50)
     - positions_value = $8,500

## Как запустить тесты

### Все тесты
```bash
python -m pytest tests/test_investor_manager_integration.py tests/test_investor_manager_unit.py -v
```

### Только интеграционные
```bash
python -m pytest tests/test_investor_manager_integration.py -v
```

### Только unit тесты
```bash
python -m pytest tests/test_investor_manager_unit.py -v
```

### С подробным выводом
```bash
python -m pytest tests/test_investor_manager_integration.py tests/test_investor_manager_unit.py -xvs
```

## Детальное описание логики

### Как работает виртуальный live счет

```
╔════════════════════════════════════════════════════════════════════╗
║                   ОДИН ФИЗИЧЕСКИЙ СЧЕТ ALPACA                      ║
║                   Общий Equity: $25,000                            ║
╚════════════════════════════════════════════════════════════════════╝
                              ↓
                    ╔═════════════════════╗
                    │  InvestorManager    │
                    │ Виртуальное разд.   │
                    ╚═════════════════════╝
                     ↙           ↓           ↘
        ╔═══════════╗    ╔═══════════╗    ╔═══════════╗
        │   LOW     │    │  MEDIUM   │    │   HIGH    │
        │   45%     │    │   35%     │    │   20%     │
        │ $11,250   │    │ $8,750    │    │ $5,000    │
        ╚═══════════╝    ╚═══════════╝    ╚═══════════╝
            ↓                  ↓                ↓
        ┌───────┐          ┌───────┐       ┌───────┐
        │ SNP500│          │SNP500 │       │ HIGH  │
        │top-50 │          │tickers│       │tickers│
        └───────┘          └───────┘       └───────┘
```

### Распределение инвесторов по ВСЕ три счета:

```
╔════════════════════════════════════════════════════════════════════╗
║                      LOW СЧЕТ ($11,250)                           ║
╠════════════════════════════════════════════════════════════════════╣
║  Инвестор │ Депозит │ % от LOW │ Доля в сделках                  ║
╠═══════════╪═════════╪══════════╪═════════════════════════════════╣
║  Alexey   │ $4,500  │   40%    │ 40% от каждой сделки на LOW     ║
║  Alex     │ $2,250  │   20%    │ 20% от каждой сделки на LOW     ║
║  Cherry   │ $4,500  │   40%    │ 40% от каждой сделки на LOW     ║
╚═══════════╧═════════╧══════════╧═════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════╗
║                    MEDIUM СЧЕТ ($8,750)                           ║
╠════════════════════════════════════════════════════════════════════╣
║  Инвестор │ Депозит │ % от MEDIUM │ Доля в сделках               ║
╠═══════════╪═════════╪═════════════╪═════════════════════════════╣
║  Alexey   │ $3,500  │    40%      │ 40% от каждой сделки на MED  ║
║  Alex     │ $1,750  │    20%      │ 20% от каждой сделки на MED  ║
║  Cherry   │ $3,500  │    40%      │ 40% от каждой сделки на MED  ║
╚═══════════╧═════════╧═════════════╧═════════════════════════════╝

╔════════════════════════════════════════════════════════════════════╗
║                    HIGH СЧЕТ ($5,000)                             ║
╠════════════════════════════════════════════════════════════════════╣
║  Инвестор │ Депозит │ % от HIGH │ Доля в сделках                 ║
╠═══════════╪═════════╪═══════════╪═════════════════════════════════╣
║  Alexey   │ $2,000  │   40%     │ 40% от каждой сделки на HIGH   ║
║  Alex     │ $1,000  │   20%     │ 20% от каждой сделки на HIGH   ║
║  Cherry   │ $2,000  │   40%     │ 40% от каждой сделки на HIGH   ║
╚═══════════╧═════════╧═══════════╧═════════════════════════════════╝

Ключево: КАЖДЫЙ инвестор имеет одинаковую ПРОПОРЦИЮ (40%/20%/40%)
на ВСЕХ трех счетах!
```

### Примеры сделок на ВСЕХ трех счетах:

#### Сделка 1: BUY 10 AAPL @ $100 на LOW
```
┌─────────────────────────────────────────────────────────────┐
│ Реальный счет Alpaca: BUY 10 AAPL @ $100 = $1,000          │
├─────────────────────────────────────────────────────────────┤
│ Распределение (40% / 20% / 40%):                            │
│ - Alexey: 10 * 0.40 = 4 акции @ $100 = $400                │
│ - Alex: 10 * 0.20 = 2 акции @ $100 = $200                  │
│ - Cherry: 10 * 0.40 = 4 акции @ $100 = $400                │
│                                                              │
│ Записи в trades.csv:                                        │
│ Alexey: 2025-11-17,10:00:00,low,BUY,AAPL,4,100,400,4       │
│ Alex:   2025-11-17,10:00:00,low,BUY,AAPL,2,100,200,2       │
│ Cherry: 2025-11-17,10:00:00,low,BUY,AAPL,4,100,400,4       │
└─────────────────────────────────────────────────────────────┘
```

#### Сделка 2: BUY 20 MSFT @ $300 на MEDIUM
```
┌─────────────────────────────────────────────────────────────┐
│ Реальный счет Alpaca: BUY 20 MSFT @ $300 = $6,000          │
├─────────────────────────────────────────────────────────────┤
│ Распределение (40% / 20% / 40%):                            │
│ - Alexey: 20 * 0.40 = 8 акций @ $300 = $2,400              │
│ - Alex: 20 * 0.20 = 4 акции @ $300 = $1,200                │
│ - Cherry: 20 * 0.40 = 8 акций @ $300 = $2,400              │
│                                                              │
│ Записи в trades.csv:                                        │
│ Alexey: 2025-11-17,11:00:00,medium,BUY,MSFT,8,300,2400,8   │
│ Alex:   2025-11-17,11:00:00,medium,BUY,MSFT,4,300,1200,4   │
│ Cherry: 2025-11-17,11:00:00,medium,BUY,MSFT,8,300,2400,8   │
└─────────────────────────────────────────────────────────────┘
```

#### Сделка 3: BUY 5 NVDA @ $800 на HIGH
```
┌─────────────────────────────────────────────────────────────┐
│ Реальный счет Alpaca: BUY 5 NVDA @ $800 = $4,000           │
├─────────────────────────────────────────────────────────────┤
│ Распределение (40% / 20% / 40%):                            │
│ - Alexey: 5 * 0.40 = 2 акции @ $800 = $1,600               │
│ - Alex: 5 * 0.20 = 1 акция @ $800 = $800                   │
│ - Cherry: 5 * 0.40 = 2 акции @ $800 = $1,600               │
│                                                              │
│ Записи в trades.csv:                                        │
│ Alexey: 2025-11-17,12:00:00,high,BUY,NVDA,2,800,1600,2     │
│ Alex:   2025-11-17,12:00:00,high,BUY,NVDA,1,800,800,1      │
│ Cherry: 2025-11-17,12:00:00,high,BUY,NVDA,2,800,1600,2     │
└─────────────────────────────────────────────────────────────┘
```

### Расчет баланса инвестора (Cherry) после всех покупок:

#### Входные данные для Cherry:
```
Operations (депозиты):
- LOW:    $4,500
- MEDIUM: $3,500
- HIGH:   $2,000

Trades (покупки):
- LOW:    4 AAPL @ $100 = $400
- MEDIUM: 8 MSFT @ $300 = $2,400
- HIGH:   2 NVDA @ $800 = $1,600
```

#### Расчет баланса на каждом счете:

**LOW Счет:**
```
1. Cash = $4,500 (deposit) - $400 (BUY AAPL) = $4,100
2. Positions = {AAPL: 4 shares @ $100 = $400}
3. P&L = 0 (цены не изменились)
4. Total = $4,100 + $400 = $4,500
```

**MEDIUM Счет:**
```
1. Cash = $3,500 (deposit) - $2,400 (BUY MSFT) = $1,100
2. Positions = {MSFT: 8 shares @ $300 = $2,400}
3. P&L = 0
4. Total = $1,100 + $2,400 = $3,500
```

**HIGH Счет:**
```
1. Cash = $2,000 (deposit) - $1,600 (BUY NVDA) = $400
2. Positions = {NVDA: 2 shares @ $800 = $1,600}
3. P&L = 0
4. Total = $400 + $1,600 = $2,000
```

**ИТОГО для Cherry:**
```
LOW:    $4,100 cash + $400 positions = $4,500
MEDIUM: $1,100 cash + $2,400 positions = $3,500
HIGH:   $400 cash + $1,600 positions = $2,000
───────────────────────────────────────────────
TOTAL VALUE: $10,000 ✅ (Чистое внесение сохранено!)
```

### Если цены выросли:

```
Новые цены:
- AAPL: $120 (было $100)
- MSFT: $330 (было $300)
- NVDA: $900 (было $800)

LOW Счет:
1. Cash = $4,100 (не изменился)
2. Positions Value = 4 * $120 = $480
3. Unrealized P&L = (120 - 100) * 4 = $80
4. Total = $4,100 + $480 = $4,580 ⬆️

MEDIUM Счет:
1. Cash = $1,100
2. Positions Value = 8 * $330 = $2,640
3. Unrealized P&L = (330 - 300) * 8 = $240
4. Total = $1,100 + $2,640 = $3,740 ⬆️

HIGH Счет:
1. Cash = $400
2. Positions Value = 2 * $900 = $1,800
3. Unrealized P&L = (900 - 800) * 2 = $200
4. Total = $400 + $1,800 = $2,200 ⬆️

ИТОГО для Cherry:
LOW:    $4,580
MEDIUM: $3,740
HIGH:   $2,200
───────────────────
TOTAL VALUE: $10,520 ⬆️
(Прибыль +$520 за счет роста цен!)
```

## Контрольные суммы

### Главное свойство системы:
```
SUM(все инвесторы.total_value) = Реальный equity счета Alpaca
```

### Контрольная сумма по инвесторам:
```
Alexey:  $10,000 (LOW: $4,500 + MEDIUM: $3,500 + HIGH: $2,000)
+ Alex:   $5,000 (LOW: $2,250 + MEDIUM: $1,750 + HIGH: $1,000)
+ Cherry: $10,000 (LOW: $4,500 + MEDIUM: $3,500 + HIGH: $2,000)
──────────────────────────────────────────────────────────────
TOTAL:   $25,000 ✅
```

### Контрольная сумма по счетам:
```
LOW Account (45% от total):
  Alexey ($4,500) + Alex ($2,250) + Cherry ($4,500) = $11,250 ✅

MEDIUM Account (35% от total):
  Alexey ($3,500) + Alex ($1,750) + Cherry ($3,500) = $8,750 ✅

HIGH Account (20% от total):
  Alexey ($2,000) + Alex ($1,000) + Cherry ($2,000) = $5,000 ✅

────────────────────────────────────────────────────────────
TOTAL:                                          $25,000 ✅
```

### Пропорции инвесторов (одинаковые на ВСЕХ счетах!):
```
На каждом счете (LOW, MEDIUM, HIGH):
  Alexey: 40%
  Alex:   20%
  Cherry: 40%
```

### После всех сделок и роста цен:
```
Alexey:
  LOW: $10,450 (был $10k, прибыль $450 от роста цен)
  MEDIUM: $8,340 (был $7.875k)
  HIGH: $4,400 (был $4k)
  ─────────────────────────────
  TOTAL: $23,190

+ Alex:
  LOW: $5,225 (был $5k)
  MEDIUM: $1,870 (был $1.75k)
  HIGH: $1,100 (был $1k)
  ─────────────────────────────
  TOTAL: $8,195

+ Cherry:
  LOW: $4,580
  MEDIUM: $3,740
  HIGH: $2,200
  ─────────────────────────────
  TOTAL: $10,520

──────────────────────────────────────────────────
GRAND TOTAL: $42,905 ❌ Это неправильно!
```

**Стоп!** Выше я неправильно рассчитал. Давайте пересчитаем правильно.

### Правильный расчет после роста цен:

Каждый инвестор имеет одинаковую долю P&L на счете!
```
LOW P&L: +$80 (от роста AAPL)
  Alexey: +$32 (40%)
  Alex:   +$16 (20%)
  Cherry: +$32 (40%)

MEDIUM P&L: +$240 (от роста MSFT)
  Alexey: +$96 (40%)
  Alex:   +$48 (20%)
  Cherry: +$96 (40%)

HIGH P&L: +$200 (от роста NVDA)
  Alexey: +$80 (40%)
  Alex:   +$40 (20%)
  Cherry: +$80 (40%)

────────────────────────────────────────
Total P&L: +$520

Новый TOTAL VALUE:
Alexey:  $10,000 + $208 = $10,208
Alex:    $5,000 + $104 = $5,104
Cherry:  $10,000 + $208 = $10,208
──────────────────────────────────────
TOTAL:   $25,000 + $520 = $25,520 ✅
```

## Как протестировать на живом счете

### Через Telegram бота:

```bash
# 1. Создать депозит
/deposit Cherry 10000

# 2. Проверить статус
/investors

# 3. Выполнить ребалансировку
/test_rebalance  # Предпросмотр
# Затем подтвердить или дождаться автоматической ребалансировки

# 4. Проверить целостность балансов
/balance_check

# 5. Экспортировать данные для анализа
/export Cherry
```

### Ручная проверка файлов:

```bash
# Проверить operations.csv
cat data/investors/Cherry/operations.csv

# Проверить trades.csv
cat data/investors/Cherry/trades.csv

# Проверить отладку баланса
python -c "
from core.investor_manager import InvestorManager
im = InvestorManager()
balance = im.calculate_investor_balance('Cherry')
print(balance)
"
```

## Ожидаемые результаты

### После депозита на Live счет:

**operations.csv:**
```csv
date,timestamp,operation,account,amount,status,balance_after
2025-11-17,10:00:00,deposit,low,4500.00,completed,4500.00
2025-11-17,10:00:00,deposit,medium,3500.00,completed,3500.00
2025-11-17,10:00:00,deposit,high,2000.00,completed,2000.00
```

### После ребалансировки:

**trades.csv:**
```csv
date,timestamp,account,action,ticker,shares,price,amount,total_shares_after
2025-11-17,10:15:00,low,BUY,AAPL,4.00,150.00,600.00,4.00
2025-11-17,10:15:00,low,BUY,MSFT,3.00,400.00,1200.00,3.00
...
```

**Баланс:**
```
LOW:
  cash: $4,500 - $600 - $1,200 - ... = $X (зависит от количества покупок)
  positions_value: 4*150 + 3*400 + ... (стоимость открытых позиций)
  pnl: (текущие цены - средние цены) * shares
  total_value: cash + positions_value
```

## Обнаруженные и исправленные проблемы

### Проблема 1: positions_value не учитывалась
**Было:** Баланс показывал только cash из operations.csv
**Решение:** Добавлены методы для расчета positions_value из trades.csv

### Проблема 2: P&L не рассчитывался
**Было:** pnl всегда = 0.0
**Решение:** Реализованы методы расчета realized и unrealized P&L

### Проблема 3: cash не учитывал расходы на покупки
**Было:** cash = deposits, но после покупок он не уменьшался
**Решение:** Обновлен `_calculate_account_balance()` чтобы вычитать BUY операции и прибавлять SELL

## Файлы которые были изменены/созданы

```
✅ Modified: core/investor_manager.py
   - _calculate_account_balance() - теперь учитывает BUY/SELL из trades.csv
   - _get_investor_positions() - получить текущие позиции
   - _calculate_positions_value_and_pnl() - новый метод расчета
   - calculate_investor_balance() - обновлен для использования новых методов
   - get_all_balances() - обновлен для расчета P&L

✅ Created: tests/test_investor_manager_integration.py
   - 5 comprehensive интеграционных тестов

✅ Created: tests/test_investor_manager_unit.py
   - 10 unit тестов для отдельных методов

✅ Created: TESTING_GUIDE.md
   - Этот документ
```

## Итого

**Тесты:** 15 тестов написаны и все ✅ прошли
- 5 интеграционных тестов (comprehensive scenarios)
- 10 unit тестов (отдельные методы)

**Код:** ~200 строк нового/измененного кода в investor_manager.py

**Покрытие:**
- ✅ Депозиты и распределение капитала
- ✅ Распределение сделок пропорционально
- ✅ Расчет positions_value
- ✅ Расчет Realized P&L
- ✅ Расчет Unrealized P&L
- ✅ Целостность контрольных сумм
- ✅ Полный цикл: депозит → ребалансировка → P&L расчет
